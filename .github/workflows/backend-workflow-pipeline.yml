name: Build and Deploy Backend to Azure VM
on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      SSH_HOST: ${{ secrets.AZURE_HOST }}
      SSH_USER: ${{ secrets.AZURE_USER }}
      SSH_PORT: ${{ secrets.AZURE_PORT }}
      REPO_URL: https://github.com/lab-dev-core/gerenciamento-organizacional-backend.git
      REPO_BRANCH: main
      APP_ROOT: /home/dev-core/htdocs/app.dev-core.online/gerenciamento-organizacional-backend
      SERVICE_NAME: gestaoformativa
      APP_PORT: "8081"
      JAR_NAME: gestaoFormativa-0.0.1-SNAPSHOT.jar
      JAVA_VERSION: "17"
      BACKEND_REPO_PAT: ${{ secrets.BACKEND_REPO_PAT }}

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          MISSING_SECRETS=()
          
          [[ -z "${{ secrets.AZURE_HOST }}" ]] && MISSING_SECRETS+=("AZURE_HOST")
          [[ -z "${{ secrets.AZURE_USER }}" ]] && MISSING_SECRETS+=("AZURE_USER")
          [[ -z "${{ secrets.AZURE_SSH_KEY }}" ]] && MISSING_SECRETS+=("AZURE_SSH_KEY")
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "ERROR: Secrets obrigatorios ausentes: ${MISSING_SECRETS[*]}"
            exit 1
          fi
          
          if [[ -z "${{ secrets.BACKEND_REPO_PAT }}" ]]; then
            echo "AVISO: BACKEND_REPO_PAT nao configurado. Se o repo for privado, o clone falhara."
          fi
          
          echo "Secrets obrigatorios presentes."

      - name: Prepare SSH key & known_hosts
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.AZURE_SSH_KEY }}" > key.pem
          chmod 600 key.pem
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          PORT_ARG=""
          if [[ -n "${SSH_PORT:-}" ]]; then PORT_ARG="-p ${SSH_PORT}"; fi
          ssh-keyscan -T 5 -H ${PORT_ARG} "${SSH_HOST}" >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts

      - name: Pre-flight check on VM
        shell: bash
        run: |
          set -euo pipefail
          PORT_OPT=""
          if [[ -n "${SSH_PORT:-}" ]]; then PORT_OPT="-p ${SSH_PORT}"; fi
          ssh ${PORT_OPT} -i key.pem "${SSH_USER}@${SSH_HOST}" << 'EOF'
          set -e
          echo "--- Checking runtime deps ---"
          
          if ! command -v java > /dev/null 2>&1; then
            echo "Java nao encontrado"; exit 1
          fi
          java -version
          
          if ! command -v mvn > /dev/null 2>&1; then
            echo "Maven nao encontrado"; exit 1
          fi
          mvn -v
          
          if ! command -v docker > /dev/null 2>&1; then
            echo "Docker nao encontrado"; exit 1
          fi
          
          if command -v docker compose > /dev/null 2>&1; then
            echo "docker compose v2 OK"
          elif command -v docker-compose > /dev/null 2>&1; then
            echo "docker-compose v1 OK"
          else
            echo "Nem 'docker compose' nem 'docker-compose' encontrados"; exit 1
          fi
          
          echo "Todas as dependencias presentes"
          EOF

      - name: Stop and disable systemd service before build
        shell: bash
        run: |
          set -euo pipefail
          PORT_OPT=""
          if [[ -n "${SSH_PORT:-}" ]]; then PORT_OPT="-p ${SSH_PORT}"; fi
          ssh ${PORT_OPT} -i key.pem "${SSH_USER}@${SSH_HOST}" << EOF
          set -e
          SERVICE_NAME="${SERVICE_NAME}"
          echo "--- Parando e desabilitando servico: \${SERVICE_NAME} ---"
          
          # Verifica se o serviço existe
          if systemctl list-unit-files | grep -q "^\${SERVICE_NAME}.service"; then
            # Para o serviço se estiver rodando
            if systemctl is-active --quiet "\${SERVICE_NAME}" 2>/dev/null; then
              echo "Parando servico ativo..."
              sudo systemctl stop "\${SERVICE_NAME}"
            fi
            
            # Desabilita para evitar restart automático
            if systemctl is-enabled --quiet "\${SERVICE_NAME}" 2>/dev/null; then
              echo "Desabilitando servico..."
              sudo systemctl disable "\${SERVICE_NAME}"
            fi
            
            # Aguarda um momento para garantir que a porta foi liberada
            echo "Aguardando porta ${APP_PORT} ser liberada..."
            sleep 2
            
            # Verifica se a porta ainda está em uso
            if sudo lsof -i :${APP_PORT} 2>/dev/null | grep -q LISTEN; then
              echo "AVISO: Porta ${APP_PORT} ainda em uso. Forcando kill do processo..."
              sudo lsof -ti :${APP_PORT} | xargs -r sudo kill -9
              sleep 1
            fi
            
            echo "Servico parado e porta liberada."
          else
            echo "Servico ainda nao existe - primeira instalacao."
          fi
          EOF

      - name: Clone/Update repo, manage DB, build JAR, systemd deploy
        shell: bash
        run: |
          set -euo pipefail
          PORT_OPT=""
          if [[ -n "${SSH_PORT:-}" ]]; then PORT_OPT="-p ${SSH_PORT}"; fi
          
          ssh ${PORT_OPT} -i key.pem "${SSH_USER}@${SSH_HOST}" \
            "REPO_URL='${REPO_URL}'" \
            "REPO_BRANCH='${REPO_BRANCH}'" \
            "APP_ROOT='${APP_ROOT}'" \
            "SERVICE_NAME='${SERVICE_NAME}'" \
            "APP_PORT='${APP_PORT}'" \
            "JAR_NAME='${JAR_NAME}'" \
            "BACKEND_REPO_PAT='${BACKEND_REPO_PAT}'" \
            bash << 'DEPLOY_EOF'
          set -e
          
          RUN_USER="$(whoami)"
          
          echo "--- Garantir APP_ROOT: ${APP_ROOT} ---"
          if [ ! -d "${APP_ROOT}" ]; then
            sudo mkdir -p "${APP_ROOT}"
            sudo chown ${RUN_USER}:${RUN_USER} "${APP_ROOT}"
          fi
          
          echo "--- Clonar/Atualizar repo ---"
          if [ -n "${BACKEND_REPO_PAT:-}" ]; then
            REPO_URL_AUTH="https://${BACKEND_REPO_PAT}@${REPO_URL#https://}"
          else
            REPO_URL_AUTH="${REPO_URL}"
          fi
          
          if [ ! -d "${APP_ROOT}/.git" ]; then
            git clone -b "${REPO_BRANCH}" "${REPO_URL_AUTH}" "${APP_ROOT}"
          else
            cd "${APP_ROOT}"
            git fetch origin
            git reset --hard "origin/${REPO_BRANCH}"
          fi
          
          echo "--- Docker Compose (DB) ---"
          cd "${APP_ROOT}"
          
          if [ ! -f "${APP_ROOT}/docker-compose.yml" ]; then
            echo "docker-compose.yml nao encontrado. Pulando gerenciamento do DB."
          else
            echo "docker-compose.yml encontrado"
            
            PROJECT_NAME=$(basename "${APP_ROOT}" | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]_-')
            
            RUNNING_CONTAINERS=$(docker ps --filter "label=com.docker.compose.project=${PROJECT_NAME}" --format '{{.Names}}' 2>/dev/null | wc -l)
            
            if [ "${RUNNING_CONTAINERS}" -gt 0 ]; then
              echo "Detectados ${RUNNING_CONTAINERS} container(s) ja rodando para o projeto."
              echo "Pulando docker-compose up - mantendo containers ativos."
              docker ps --filter "label=com.docker.compose.project=${PROJECT_NAME}" --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'
            else
              echo "Nenhum container rodando. Iniciando stack do banco de dados..."
              
              if docker compose version >/dev/null 2>&1; then
                echo "Usando: docker compose"
                docker compose up -d
              elif command -v docker-compose >/dev/null 2>&1; then
                echo "Usando: docker-compose"
                docker-compose up -d
              else
                echo "Nem 'docker compose' nem 'docker-compose' disponiveis!"
                echo "Continuando sem iniciar DB - pode causar falha na aplicacao."
              fi
              
              if [ "${RUNNING_CONTAINERS}" -eq 0 ]; then
                echo "Aguardando 10s para DB inicializar..."
                sleep 10
              fi
            fi
          fi
          
          echo "--- Build Maven ---"
          cd "${APP_ROOT}"
          echo "Executando: mvn clean package"
          mvn -B clean package -DskipTests
          
          echo "--- Identificando JAR ---"
          if [ -f "target/${JAR_NAME}" ]; then
            JAR_PATH="$(realpath "target/${JAR_NAME}")"
            echo "JAR encontrado: ${JAR_PATH}"
          else
            JAR_PATH="$(ls -1 target/*.jar 2>/dev/null | head -n 1)"
            if [ -z "${JAR_PATH}" ]; then
              echo "Nenhum JAR encontrado em target/. Build falhou?"
              exit 1
            fi
            JAR_PATH="$(realpath "${JAR_PATH}")"
            echo "${JAR_NAME} nao encontrado, usando: ${JAR_PATH}"
          fi
          
          echo "--- Criando/atualizando servico systemd: ${SERVICE_NAME} ---"
          
          cat > /tmp/${SERVICE_NAME}.service << 'SYSTEMD_EOF'
          [Unit]
          Description=Gestao Formativa Backend
          After=network.target docker.service
          
          [Service]
          Type=simple
          User=USER_PLACEHOLDER
          WorkingDirectory=WORKDIR_PLACEHOLDER
          ExecStart=/usr/bin/java -jar JAR_PLACEHOLDER --server.port=PORT_PLACEHOLDER
          Restart=always
          RestartSec=5
          StandardOutput=journal
          StandardError=journal
          
          [Install]
          WantedBy=multi-user.target
          SYSTEMD_EOF
          
          sed -i "s|USER_PLACEHOLDER|${RUN_USER}|g" /tmp/${SERVICE_NAME}.service
          sed -i "s|WORKDIR_PLACEHOLDER|${APP_ROOT}|g" /tmp/${SERVICE_NAME}.service
          sed -i "s|JAR_PLACEHOLDER|${JAR_PATH}|g" /tmp/${SERVICE_NAME}.service
          sed -i "s|PORT_PLACEHOLDER|${APP_PORT}|g" /tmp/${SERVICE_NAME}.service
          
          sudo mv /tmp/${SERVICE_NAME}.service /etc/systemd/system/${SERVICE_NAME}.service
          sudo chmod 644 /etc/systemd/system/${SERVICE_NAME}.service
          
          echo "--- Verificando se porta esta livre ---"
          if sudo lsof -i :${APP_PORT} 2>/dev/null | grep -q LISTEN; then
            echo "ERRO: Porta ${APP_PORT} ainda em uso!"
            echo "Processos usando a porta:"
            sudo lsof -i :${APP_PORT}
            echo ""
            echo "Forcando kill do processo..."
            sudo lsof -ti :${APP_PORT} | xargs -r sudo kill -9
            sleep 2
          else
            echo "Porta ${APP_PORT} livre."
          fi
          
          echo "--- Habilitando e iniciando servico ---"
          sudo systemctl daemon-reload
          sudo systemctl enable "${SERVICE_NAME}"
          sudo systemctl restart "${SERVICE_NAME}"
          
          echo "Aguardando aplicacao inicializar..."
          sleep 3
          
          sudo systemctl status "${SERVICE_NAME}" --no-pager -l || true
          
          echo ""
          echo "--- Health check com retentativas ---"
          if command -v curl > /dev/null 2>&1; then
            MAX_ATTEMPTS=30
            ATTEMPT=1
            HEALTH_OK=false
            
            echo "Tentando conectar na aplicacao (max ${MAX_ATTEMPTS} tentativas, intervalo 2s)..."
            
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo -n "Tentativa $ATTEMPT/$MAX_ATTEMPTS... "
              
              # Tenta actuator/health primeiro
              if curl -sf --connect-timeout 2 "http://localhost:${APP_PORT}/actuator/health" > /dev/null 2>&1; then
                echo "Health check OK!"
                HEALTH_OK=true
                break
              # Tenta endpoint raiz
              elif curl -sf --connect-timeout 2 "http://localhost:${APP_PORT}" > /dev/null 2>&1; then
                echo "Aplicacao respondendo!"
                HEALTH_OK=true
                break
              # Verifica se o processo ainda está rodando
              elif ! systemctl is-active --quiet "${SERVICE_NAME}"; then
                echo "FALHOU - servico parou!"
                echo ""
                echo "Logs do servico:"
                sudo journalctl -u "${SERVICE_NAME}" -n 50 --no-pager
                exit 1
              else
                echo "aguardando..."
                sleep 2
                ATTEMPT=$((ATTEMPT + 1))
              fi
            done
            
            if [ "$HEALTH_OK" = true ]; then
              echo ""
              echo "==================================="
              echo "Deploy concluido com sucesso!"
              echo "Aplicacao rodando na porta ${APP_PORT}"
              echo "==================================="
            else
              echo ""
              echo "AVISO: Aplicacao nao respondeu apos ${MAX_ATTEMPTS} tentativas (60s)."
              echo "O servico esta rodando, mas pode estar inicializando ainda."
              echo ""
              echo "Ultimos logs:"
              sudo journalctl -u "${SERVICE_NAME}" -n 50 --no-pager
              echo ""
              echo "Verifique manualmente com:"
              echo "  sudo systemctl status ${SERVICE_NAME}"
              echo "  sudo journalctl -u ${SERVICE_NAME} -f"
              echo "  curl http://localhost:${APP_PORT}/actuator/health"
            fi
          else
            echo "curl nao disponivel - pulando health check"
          fi
          
          echo "Deploy concluido com sucesso!"
          DEPLOY_EOF

      - name: Cleanup
        if: always()
        shell: bash
        run: |
          rm -f key.pem

      - name: Troubleshooting on failure
        if: failure()
        shell: bash
        run: |
          echo "Falha no deploy do backend. Verifique:"
          echo ""
          echo "1. Dependencias na VM:"
          echo "   - Docker, Java 17 e Maven instalados"
          echo "   - Usuario no grupo docker: sudo usermod -aG docker \$USER"
          echo ""
          echo "2. Rede e Firewall:"
          echo "   - Porta ${APP_PORT} liberada no NSG/firewall"
          echo "   - Docker network configurado corretamente"
          echo ""
          echo "3. Permissoes:"
          echo "   - Usuario ${SSH_USER} com acesso ao ${APP_ROOT}"
          echo "   - Permissoes sudo configuradas"
          echo ""
          echo "4. Repositorio:"
          echo "   - Se privado, configure BACKEND_REPO_PAT nos secrets"
          echo ""
          echo "5. Logs na VM:"
          echo "   sudo journalctl -u ${SERVICE_NAME} -n 100 --no-pager"
          echo "   sudo systemctl status ${SERVICE_NAME}"
          echo ""
          echo "6. Banco de Dados:"
          echo "   - Verifique se o docker-compose.yml esta correto"
          echo "   - Confirme que os containers estao rodando: docker ps"
