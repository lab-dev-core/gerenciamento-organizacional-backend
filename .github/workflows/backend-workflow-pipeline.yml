name: Build and Deploy Backend to Azure VM
on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      SSH_HOST: ${{ secrets.AZURE_HOST }}
      SSH_USER: ${{ secrets.AZURE_USER }}
      SSH_PORT: ${{ secrets.AZURE_PORT }}
      REPO_URL: https://github.com/lab-dev-core/gerenciamento-organizacional-backend.git
      REPO_BRANCH: main
      APP_ROOT: /home/dev-core/htdocs/app.dev-core.online/gerenciamento-organizacional-backend
      SERVICE_NAME: gestaoformativa
      APP_PORT: "8081"
      JAR_NAME: gestaoFormativa-0.0.1-SNAPSHOT.jar
      JAVA_VERSION: "17"
      BACKEND_REPO_PAT: ${{ secrets.BACKEND_REPO_PAT }}

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          MISSING_SECRETS=()
          
          [[ -z "${{ secrets.AZURE_HOST }}" ]] && MISSING_SECRETS+=("AZURE_HOST")
          [[ -z "${{ secrets.AZURE_USER }}" ]] && MISSING_SECRETS+=("AZURE_USER")
          [[ -z "${{ secrets.AZURE_SSH_KEY }}" ]] && MISSING_SECRETS+=("AZURE_SSH_KEY")
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "‚ùå ERROR: Secrets obrigat√≥rios ausentes: ${MISSING_SECRETS[*]}"
            exit 1
          fi
          
          # Aviso se PAT n√£o estiver configurado (para repos privados)
          if [[ -z "${{ secrets.BACKEND_REPO_PAT }}" ]]; then
            echo "‚ö†Ô∏è  AVISO: BACKEND_REPO_PAT n√£o configurado. Se o repo for privado, o clone falhar√°."
          fi
          
          echo "‚úÖ Secrets obrigat√≥rios presentes."

      - name: Prepare SSH key & known_hosts
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.AZURE_SSH_KEY }}" > key.pem
          chmod 600 key.pem
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          PORT_ARG=""
          if [[ -n "${SSH_PORT:-}" ]]; then PORT_ARG="-p ${SSH_PORT}"; fi
          ssh-keyscan -T 5 -H ${PORT_ARG} "${SSH_HOST}" >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts

      - name: Pre-flight check on VM (java/maven/docker)
        shell: bash
        run: |
          set -euo pipefail
          PORT_OPT=""
          if [[ -n "${SSH_PORT:-}" ]]; then PORT_OPT="-p ${SSH_PORT}"; fi
          ssh ${PORT_OPT} -i key.pem "${SSH_USER}@${SSH_HOST}" << 'EOF'
          set -e
          echo "--- Checking runtime deps ---"
          
          if ! command -v java > /dev/null 2>&1; then
            echo "‚ùå Java n√£o encontrado"; exit 1
          fi
          java -version
          
          if ! command -v mvn > /dev/null 2>&1; then
            echo "‚ùå Maven n√£o encontrado"; exit 1
          fi
          mvn -v
          
          if ! command -v docker > /dev/null 2>&1; then
            echo "‚ùå Docker n√£o encontrado"; exit 1
          fi
          
          if command -v docker compose > /dev/null 2>&1; then
            echo "‚úÖ docker compose v2 OK"
          elif command -v docker-compose > /dev/null 2>&1; then
            echo "‚úÖ docker-compose v1 OK"
          else
            echo "‚ùå Nem 'docker compose' nem 'docker-compose' encontrados"; exit 1
          fi
          
          echo "‚úÖ Todas as depend√™ncias presentes"
          EOF

      - name: Stop systemd service before build
        shell: bash
        run: |
          set -euo pipefail
          PORT_OPT=""
          if [[ -n "${SSH_PORT:-}" ]]; then PORT_OPT="-p ${SSH_PORT}"; fi
          ssh ${PORT_OPT} -i key.pem "${SSH_USER}@${SSH_HOST}" << EOF
          set -e
          SERVICE_NAME="${SERVICE_NAME}"
          echo "--- Parando servi√ßo systemd: \${SERVICE_NAME} ---"
          if systemctl is-active --quiet "\${SERVICE_NAME}" 2>/dev/null; then
            sudo systemctl stop "\${SERVICE_NAME}"
            echo "‚úÖ Servi√ßo parado."
          else
            echo "‚ÑπÔ∏è  Servi√ßo n√£o estava ativo."
          fi
          EOF

      - name: Clone/Update repo, manage DB, build JAR, systemd deploy
        shell: bash
        run: |
          set -euo pipefail
          PORT_OPT=""
          if [[ -n "${SSH_PORT:-}" ]]; then PORT_OPT="-p ${SSH_PORT}"; fi
          
          # Passa vari√°veis para o SSH
          ssh ${PORT_OPT} -i key.pem "${SSH_USER}@${SSH_HOST}" \
            "REPO_URL='${REPO_URL}'" \
            "REPO_BRANCH='${REPO_BRANCH}'" \
            "APP_ROOT='${APP_ROOT}'" \
            "SERVICE_NAME='${SERVICE_NAME}'" \
            "APP_PORT='${APP_PORT}'" \
            "JAR_NAME='${JAR_NAME}'" \
            "BACKEND_REPO_PAT='${BACKEND_REPO_PAT}'" \
            bash << 'DEPLOY_EOF'
          set -e
          
          RUN_USER="$(whoami)"
          
          echo "--- Garantir APP_ROOT: ${APP_ROOT} ---"
          if [ ! -d "${APP_ROOT}" ]; then
            sudo mkdir -p "${APP_ROOT}"
            sudo chown ${RUN_USER}:${RUN_USER} "${APP_ROOT}"
          fi
          
          echo "--- Clonar/Atualizar repo ---"
          # Configura autentica√ß√£o se PAT estiver dispon√≠vel
          if [ -n "${BACKEND_REPO_PAT:-}" ]; then
            REPO_URL_AUTH="https://${BACKEND_REPO_PAT}@${REPO_URL#https://}"
          else
            REPO_URL_AUTH="${REPO_URL}"
          fi
          
          if [ ! -d "${APP_ROOT}/.git" ]; then
            git clone -b "${REPO_BRANCH}" "${REPO_URL_AUTH}" "${APP_ROOT}"
          else
            cd "${APP_ROOT}"
            git fetch origin
            git reset --hard "origin/${REPO_BRANCH}"
          fi
          
          echo "--- Docker Compose (DB) ---"
          cd "${APP_ROOT}"
          
          # Verifica se existe docker-compose.yml
          if [ ! -f "${APP_ROOT}/docker-compose.yml" ]; then
            echo "‚ö†Ô∏è  docker-compose.yml n√£o encontrado. Pulando gerenciamento do DB."
          else
            echo "‚úÖ docker-compose.yml encontrado"
            
            # Verifica se os containers do projeto j√° est√£o rodando via docker ps
            PROJECT_NAME=$(basename "${APP_ROOT}" | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]_-')
            
            # Conta containers rodando que pertencem a este projeto
            RUNNING_CONTAINERS=$(docker ps --filter "label=com.docker.compose.project=${PROJECT_NAME}" --format '{{.Names}}' 2>/dev/null | wc -l)
            
            if [ "${RUNNING_CONTAINERS}" -gt 0 ]; then
              echo "‚ÑπÔ∏è  Detectados ${RUNNING_CONTAINERS} container(s) j√° rodando para o projeto."
              echo "‚ÑπÔ∏è  Pulando docker-compose up - mantendo containers ativos."
              docker ps --filter "label=com.docker.compose.project=${PROJECT_NAME}" --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'
            else
              echo "üöÄ Nenhum container rodando. Iniciando stack do banco de dados..."
              
              # Determina comando do compose e executa
              if docker compose version >/dev/null 2>&1; then
                echo "üì¶ Usando: docker compose"
                docker compose up -d
              elif command -v docker-compose >/dev/null 2>&1; then
                echo "üì¶ Usando: docker-compose"
                docker-compose up -d
              else
                echo "‚ùå Nem 'docker compose' nem 'docker-compose' dispon√≠veis!"
                echo "‚ö†Ô∏è  Continuando sem iniciar DB - pode causar falha na aplica√ß√£o."
              fi
              
              # Aguarda DB estar pronto
              if [ "${RUNNING_CONTAINERS}" -eq 0 ]; then
                echo "‚è≥ Aguardando 15s para DB inicializar..."
                sleep 15
              fi
            fi
          fi
          
          echo "--- Build Maven ---"
          cd "${APP_ROOT}"
          echo "üî® Executando: mvn clean package"
          mvn -B clean package -DskipTests
          
          echo "--- Identificando JAR ---"
          if [ -f "target/${JAR_NAME}" ]; then
            JAR_PATH="$(realpath "target/${JAR_NAME}")"
            echo "‚úÖ JAR encontrado: ${JAR_PATH}"
          else
            JAR_PATH="$(ls -1 target/*.jar 2>/dev/null | head -n 1)"
            if [ -z "${JAR_PATH}" ]; then
              echo "‚ùå Nenhum JAR encontrado em target/. Build falhou?"
              exit 1
            fi
            JAR_PATH="$(realpath "${JAR_PATH}")"
            echo "‚ö†Ô∏è  ${JAR_NAME} n√£o encontrado, usando: ${JAR_PATH}"
          fi
          
          echo "--- Criando/atualizando servi√ßo systemd: ${SERVICE_NAME} ---"
          
          # Cria arquivo tempor√°rio com a configura√ß√£o do servi√ßo
          cat > /tmp/${SERVICE_NAME}.service << SYSTEMD_EOF
[Unit]
Description=Gestao Formativa Backend
After=network.target docker.service

[Service]
Type=simple
User=${RUN_USER}
WorkingDirectory=${APP_ROOT}
ExecStart=/usr/bin/java -jar ${JAR_PATH} --server.port=${APP_PORT}
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
SYSTEMD_EOF
          
          # Move o arquivo para /etc/systemd/system/ usando sudo
          sudo mv /tmp/${SERVICE_NAME}.service /etc/systemd/system/${SERVICE_NAME}.service
          sudo chmod 644 /etc/systemd/system/${SERVICE_NAME}.service
          
          echo "--- Habilitando e iniciando servi√ßo ---"
          sudo systemctl daemon-reload
          sudo systemctl enable "${SERVICE_NAME}"
          sudo systemctl restart "${SERVICE_NAME}"
          
          echo "‚è≥ Aguardando 5s para aplica√ß√£o iniciar..."
          sleep 5
          
          sudo systemctl status "${SERVICE_NAME}" --no-pager -l || true
          
          echo "--- Health check ---"
          if command -v curl > /dev/null 2>&1; then
            echo "üîç Verificando health endpoint..."
            if curl -sf "http://localhost:${APP_PORT}/actuator/health" > /dev/null; then
              echo "‚úÖ Health check OK!"
            elif curl -sf "http://localhost:${APP_PORT}" > /dev/null; then
              echo "‚úÖ Aplica√ß√£o respondendo (sem actuator)!"
            else
              echo "‚ö†Ô∏è  Aplica√ß√£o n√£o est√° respondendo. Verifique os logs."
              sudo journalctl -u "${SERVICE_NAME}" -n 30 --no-pager
              exit 1
            fi
          fi
          
          echo "üéâ Deploy conclu√≠do com sucesso!"
          DEPLOY_EOF

      - name: Cleanup
        if: always()
        shell: bash
        run: |
          rm -f key.pem

      - name: Troubleshooting on failure
        if: failure()
        shell: bash
        run: |
          echo "‚ùå Falha no deploy do backend. Verifique:"
          echo ""
          echo "1Ô∏è‚É£  Depend√™ncias na VM:"
          echo "   - Docker, Java 17 e Maven instalados"
          echo "   - Usu√°rio no grupo docker: sudo usermod -aG docker \$USER"
          echo ""
          echo "2Ô∏è‚É£  Rede e Firewall:"
          echo "   - Porta ${APP_PORT} liberada no NSG/firewall"
          echo "   - Docker network configurado corretamente"
          echo ""
          echo "3Ô∏è‚É£  Permiss√µes:"
          echo "   - Usu√°rio ${SSH_USER} com acesso ao ${APP_ROOT}"
          echo "   - Permiss√µes sudo configuradas"
          echo ""
          echo "4Ô∏è‚É£  Reposit√≥rio:"
          echo "   - Se privado, configure BACKEND_REPO_PAT nos secrets"
          echo ""
          echo "5Ô∏è‚É£  Logs na VM:"
          echo "   sudo journalctl -u ${SERVICE_NAME} -n 100 --no-pager"
          echo "   sudo systemctl status ${SERVICE_NAME}"
          echo ""
          echo "6Ô∏è‚É£  Banco de Dados:"
          echo "   - Verifique se o docker-compose.yml est√° correto"
          echo "   - Confirme que os containers est√£o rodando: docker ps"
