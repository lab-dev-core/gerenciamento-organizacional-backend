
name: Test SSH to Azure VM

on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]  # opcional: rode a cada push para validar

jobs:
  ssh-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Prepare SSH key
        shell: bash
        run: |
          # Escreve a chave privada a partir do secret
          echo "${{ secrets.AZURE_SSH_KEY }}" > key.pem
          chmod 600 key.pem
          # Cria diretório .ssh para known_hosts
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

      - name: Add host to known_hosts via ssh-keyscan
        shell: bash
        run: |
          # Captura a chave do servidor para evitar StrictHostKeyChecking=no
          ssh-keyscan -T 5 -H ${{ secrets.AZURE_HOST }} >> ~/.ssh/known_hosts
          # Opcional: se usar hostname, adicione também
          # ssh-keyscan -T 5 -H myvm.example.com >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
        # Observação: se sua VM estiver em uma porta SSH diferente (ex.: 2222), use:
        # ssh-keyscan -T 5 -p 2222 -H ${{ secrets.AZURE_HOST }} >> ~/.ssh/known_hosts

      - name: Test raw SSH connectivity
        shell: bash
        run: |
          # Tenta uma conexão simples e roda comandos leves
          ssh -i key.pem ${{ secrets.AZURE_USER }}@${{ secrets.AZURE_HOST }} \
            "echo 'Connected OK'; whoami; uname -a; ls -ld ~; date"

      - name: Test SFTP (optional)
        shell: bash
        run: |
          # Lista diretório home via SFTP para validar transferência
          sftp -i key.pem ${{ secrets.AZURE_USER }}@${{ secrets.AZURE_HOST }} << 'EOF'
          pwd
          ls -l
          EOF

      - name: Dry-run rsync (no files copied)
        shell: bash
        run: |
          # Cria diretório temporário com um arquivo mock para testar o rsync
          mkdir -p testdir && echo "hello" > testdir/hello.txt
          rsync -avzn --delete -e "ssh -i key.pem" \
            testdir/ ${{ secrets.AZURE_USER }}@${{ secrets.AZURE_HOST }}:/var/www/myapp/
          # Explicação:
          # -a: archive (permissões/recursivo)
          # -v: verbose
          # -z: compressão
          # -n: dry-run (não copia)
          # --delete: mostra o que seria removido no destino

      - name: Remote environment check (permission + disk + firewall)
        shell: bash
        run: |
          ssh -i key.pem ${{ secrets.AZURE_USER }}@${{ secrets.AZURE_HOST }} << 'EOF'
            set -e
            echo "--- ENV CHECK ---"
            id
            echo "Home: $HOME"
            echo "SSH server version:"; sshd -T | head -n 5 || echo "sshd -T not available"
            echo "Uptime:"; uptime || true
            echo "Disk space:"; df -h / || true
            echo "Target dir:"
            sudo mkdir -p /var/www/myapp || true
            sudo chown $USER:$USER /var/www/myapp || true
            ls -ld /var/www/myapp || true
          EOF

      - name: Troubleshooting helpers on failure
        if: failure()
        shell: bash
        run: |
          echo "If failure occurred:"
          echo "1) Check if AZURE_SSH_KEY is a valid private key (PEM) and not the public .pub."
          echo "2) Ensure AZURE_USER exists on VM and has SSH access."
          echo "3) Verify VM NSG/firewall allows inbound TCP 22."
          echo "4) If SSH port != 22, add -p <port> to ssh/ssh-keyscan/rsync."
          echo "5) If using cloud-init keys, confirm ~/.ssh/authorized_keys contains the matching public key."
